<!--suppress ALL, JSAnnotator -->
<template>
<div class="page page-with-subnavbar" data-name="viewInv">
    <div class="navbar" id="inventoryNavbar">
        <div class="navbar-inner">
            <div class="left">
                <a href="#" class="link icon-only panel-open" data-panel="left">
                    <i class="icon f7-icons">menu</i>
                </a>
                <a href="#" class="link back">
                    <i class="icon icon-back"></i>
                    <span class="ios-only">Назад</span>
                </a>
            </div>
            <div class="title sliding">Инвентаризация<br>{{item.docID}} от {{item.docDate}}</div>
            <div class="subnavbar" id="inventorySubNavbar">
                <div class="subnavbar-inner">
                    <div class="row">
                        <input type="number" class="col" style="height:36px;min-width:200px;" id="barCodeInput" placeholder="Штрихкод товара" @keypress="barcodeInputKeypress">
                        <span class="col button button-outline button-round" style="width:80px;" @click="barcodeInputEnter">ВВОД</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="page-content" id="pageContentInventory">
        <table id="tableWithFixedHead" width="100%" style="position:fixed; top:104px; z-index: 100">
            <thead>
            <tr id="tableFixedHeader">
                <th id="num_td" style="width:40px;">№ <br>п/п</th>
                <th id="code_td">Штрихкод</th>
                <th id="um_td" style="width:50px;">Ед. изм</th>
                <th id="doc_qty" style="width:50px;">Уч. кол-во</th>
                <th id="real_qty" style="width:50px;">Факт. кол-во</th>
            </tr>
            </thead>
        </table>
        <table id="inventoryTable" width="100%" style="margin-bottom: 32px;">
        </table>
        <table id="tableWithFixedFooter" width="100%" style="position:fixed; bottom:0px; z-index: 100">
            <tfoot>
            <tr id="footTableFixedHeader">
                <td id="totalRowQty">0</td>
                <td id="totalEmpty"></td>
                <td id="totalDocQty" >0</td>
                <td id="totalRealQty">0</td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>
</template>
<script>
    return {
        data: function data() {                                                                         console.log('viewInv.html data',this);
            let invData={},listInvsData=this.$app.data.viewListInvs.listInvs;
            if(!this.$route.params) return invData;
            let invChID=this.$route.params.invChID;
            if(invChID===null||invChID===undefined) return invData;
            if(listInvsData){
                for(let ind in listInvsData){
                    let itemInvData=listInvsData[ind];
                    if(itemInvData&&itemInvData.chID==invChID){
                        invData=itemInvData;
                        break;
                    }
                }
            }
            return {item:invData,items:[]};
        },
        methods: {
            createTableRow: function(barcode){                                                             console.log('viewInv.html createTableRow barcode=',barcode, this);
                var app7=this.$app;
                if(!barcode){
                    app7.dialog.alert("Не удалось считать код", "Внимание");
                    return;
                }
                if(document.getElementById(barcode)){
                    document.getElementById(barcode).innerText=parseInt(document.getElementById(barcode).innerText)+1;
                    document.getElementById("barCodeInput").value='';
                    this.setTotalQty();
                    return;
                }
                let mainTable=document.getElementById('inventoryTable'),
                    trHigher=document.createElement('tr'),
                    tdRowNum=document.createElement('td'),tdProdName=document.createElement('td');
                this.inventoryTableRowNum++;
                tdRowNum.innerText=this.inventoryTableRowNum.toString(); tdRowNum.className='text-centered';
                tdProdName.innerText="Товар со штрих-кодом "+barcode; tdProdName.className="blue-text";
                trHigher.appendChild(tdRowNum); trHigher.appendChild(tdProdName);
                let trLower=document.createElement('tr'),
                    tdBarCode=document.createElement('td'), tdUm=document.createElement('td'),
                    tdRef=document.createElement('td'), tdReal=document.createElement('td'), thisInstance=this;
                tdReal.id=barcode;
                // tbody.onclick=  function(){
                //     thisInstance.showRealQtyFunction(tdReal, tdReal.innerText.trim(),tdProdName.innerText);
                //     if(document.getElementById('clickedTableRow')) document.getElementById('clickedTableRow').id="";
                //     tbody.id="clickedTableRow";
                // };
                tdRowNum.style.width=(document.getElementById('num_td').offsetWidth-11) + "px";
                tdUm.style.width=(document.getElementById('um_td').offsetWidth-11) + "px";
                tdRef.style.width=(document.getElementById('doc_qty').offsetWidth-11) + "px"; tdRef.style.textAlign="center";
                tdReal.style.width=(document.getElementById('real_qty').offsetWidth-11) + "px"; tdReal.style.textAlign="center";
                tdBarCode.innerText=barcode; tdUm.innerText='шт'; tdRef.innerText='1'; tdReal.innerText='1';
                tdUm.className='text-centered'; //tdRef.className='text-right'; //tdReal.className='text-right';
                tdRef.className='refQty'; tdReal.className='realQty';
                trLower.appendChild(tdBarCode); trLower.appendChild(tdUm); trLower.appendChild(tdRef); trLower.appendChild(tdReal);
                mainTable.appendChild(trHigher); mainTable.appendChild(trLower);
                tdRowNum.rowSpan='2'; tdProdName.colSpan='4';
                document.getElementById("totalRowQty").innerHTML=this.inventoryTableRowNum;
                this.setTotalQty();
                document.getElementById("barCodeInput").value='';
            },
            setTotalQty: function(){
                let refQtylist = document.getElementsByClassName("refQty"), realQtylist = document.getElementsByClassName("realQty");
                let totalrefQty=0,totalrealQty=0;
                for(var tdIndex=0; tdIndex<refQtylist.length; tdIndex++){
                    totalrealQty+=parseInt(realQtylist[tdIndex].innerHTML);
                    totalrefQty+=parseInt(refQtylist[tdIndex].innerHTML);
                }
                document.getElementById("totalDocQty").innerHTML=totalrefQty;
                document.getElementById("totalRealQty").innerHTML=totalrealQty;
            },
            showRealQtyFunction: function(cell, displayedQty, prodName){
                var app7=this.$app;
                let thisInstance=this,
                    realQtyDialog=app7.dialog.create({
                        destroyOnClose:true,
                        content:'<br><input id="inputRealQty" type="number" style="text-align:center;border:1px solid grey;padding:5px" value="'+displayedQty+'"></<input>',
                        title: 'Фактический остаток',
                        text:prodName,
                        on:{
                            open:function(){
                                document.getElementById("inputRealQty").focus();
                            },
                        },
                        buttons:[
                            {
                                text:"ОТМЕНА",onClick:function(){
                                    realQtyDialog.close();
                                }
                            },
                            {
                                text:"ВВОД",keyCodes:[13],onClick:function(){
                                    cell.innerText=document.getElementById("inputRealQty").value.trim() || 0;
                                    thisInstance.setTotalQty();
                                    realQtyDialog.close();
                                }
                            }
                        ]
                    }).open();
            },
            barcodeInputEnter: function () {
                var $$ = Dom7, self=this;                                                               //console.log('viewInv.html enterBarCode', self);
                self.createTableRow($$("#barCodeInput").val());
            },
            barcodeInputKeypress: function (e) {
                var $$ = Dom7, self=this;                                                               //console.log('viewInv.html enterBarCode', self);
                // self.$app.dialog.alert('enterBarCode');
                if(e.keyCode==13||e.key=='Enter') self.createTableRow($$("#barCodeInput").val());
            }
        },
        on: {
            pageInit: function(e, page) {                                                                console.log('viewInv.html pageInit', page, this);
                let $$ = Dom7, cInstance=this, app7=this.$app;                                  //console.log('viewInv.html pageInit 1=', $$("#enterRowButton"),$$("#barCodeInput"));
                cInstance.inventoryTableRowNum=0;
            },
            pageBeforeIn: function(e, page) {                                                                console.log('viewInv.html pageBeforeIn', page);
                $$("#app").prop("data-workingDoc", "inventory");
                //$$("#app").addClass("inventory");
                //$$(document).workingDoc="";
                //$$('#barCodeInput').on('blur', '#barCodeInput', function(e){
                //  $$(e.target).focus();
                //});
                let maxWidth=document.getElementById("tableWithFixedHead").clientWidth+1+'px';
                document.getElementById("inventoryTable").style.marginTop=(document.getElementById("tableFixedHeader").offsetHeight)  +'px';
                document.getElementById("totalRowQty").style.width=(document.getElementById('num_td').offsetWidth-11) + "px";
                document.getElementById("totalDocQty").style.width= (document.getElementById('doc_qty').offsetWidth-11) + "px";
                document.getElementById("totalRealQty").style.width= (document.getElementById('real_qty').offsetWidth-11) + "px";
            },
            pageAfterIn: function(e, page) {                                                                console.log('viewInv.html pageAfterIn', page);
                $$("#barCodeInput").focus();
            },
            // pageBeforeOut: function(e, page) {
            //     console.log('pageBeforeOut', page);
            // },
            // pageAfterOut: function(e, page) {
            //     console.log('pageAfterOut', page);
            // },
        }
    }
</script>
