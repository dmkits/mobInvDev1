<!--suppress ALL, JSAnnotator -->
<template>
<div class="page page-with-subnavbar" data-name="viewInvent">
    <div class="navbar" id="inventoryNavbar">
        <div class="navbar-inner">
            <div class="left">
                <a href="#" class="link icon-only panel-open" data-panel="left">
                    <i class="icon f7-icons">menu</i>
                </a>
                <a href="#" class="link back">
                    <i class="icon icon-back"></i>
                    <span class="ios-only">Назад</span>
                </a>
            </div>
            <div class="title sliding">Инвентаризация<br>{{item.docID}} от {{item.docDate}}</div>
            <div class="subnavbar" id="inventorySubNavbar">
                <div class="subnavbar-inner">
                    <div class="row">
                        <input type="number" class="col" style="height:36px;min-width:200px;" id="barCodeInput" placeholder="Штрихкод товара" @keypress="barcodeInputKeypress">
                        <span class="col button button-outline button-round" style="width:80px;" @click="barcodeInputEnter">ВВОД</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="page-content" id="pageContentInventory">
        <table id="tableWithFixedHead" width="100%" style="position:fixed; top:104px; z-index: 100">
            <thead>
            <tr id="tableFixedHeader">
                <th id="num_td" style="width:40px;">№ <br>п/п</th>
                <th id="code_td">Штрихкод</th>
                <th id="um_td" style="width:50px;">Ед. изм</th>
                <th id="doc_qty" style="width:50px;">Уч. кол-во</th>
                <th id="real_qty" style="width:50px;">Факт. кол-во</th>
            </tr>
            </thead>
        </table>
        <table id="inventoryTable" width="100%" style="margin-bottom: 32px;">
        </table>
        <table id="tableWithFixedFooter" width="100%" style="position:fixed; bottom:0px; z-index: 100">
            <tfoot>
            <tr id="footTableFixedHeader">
                <td id="totalRowQty">0</td>
                <td id="totalEmpty"></td>
                <td id="totalDocQty" >0</td>
                <td id="totalRealQty">0</td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>
</template>
<script>
    return {
        data: function data() {                                                                             //console.log('viewInvent.html data',this);
            let inventData={},listInventsData=this.$app.data.viewListInvents.listInvents;
            if(!this.$route.params) return inventData;
            let inventChID=this.$route.params.inventChID;
            if(inventChID===null||inventChID===undefined) return inventData;
            if(listInventsData){
                for(let ind in listInventsData){
                    let itemInventData=listInventsData[ind];
                    if(itemInventData&&itemInventData.chID==inventChID){
                        inventData=itemInventData;
                        break;
                    }
                }
            }
            return {item:inventData,items:[]};
        },
        methods: {
            /**
             * callback = function(inventData,err)
             */
            loadInventData: function(chID,callback) {                                                      //console.log('viewInvent.html loadInventData chID=',chID, this);
                callback([{}]);
            },
            /**
             * callback = function(prodData,err)
             */
            getProdData: function(barcode,callback) {                                                      //console.log('viewInvent.html getProdData barcode=',barcode, this);
                if(!barcode){
                    var self=this;
                    if(!this.dialogAlertNoBarcode)
                        this.dialogAlertNoBarcode=
                            app7.dialog.alert("Не удалось считать штрихкод", "Внимание",function(){
                                self.dialogAlertNoBarcode=null;$$("#barCodeInput").focus();
                            });
                    else
                        this.dialogAlertNoBarcode.open();
                    $$("#barCodeInput").focus();
                    return;
                }
                callback({Barcode:barcode,ProdName:'Товар со штрихкодом '+barcode,UM:'шт.'});
            },
            createTableRow: function(prodData){                                                             //console.log('viewInvent.html createTableRow prodData=',prodData, this);
                var app7=this.$app;
                if(!prodData){
                    if(!this.dialogAlertNoProd)
                        this.dialogAlertNoProd=
                            app7.dialog.alert("Не удалось получить данные товара", "Внимание",function(){
                                self.dialogAlertNoProd=null;$$("#barCodeInput").focus();
                            });
                    else
                        this.dialogAlertNoProd.open();
                    return;
                }
                var existstdReal=document.getElementById(prodData["Barcode"]);
                if(existstdReal){
                    existstdReal.innerText=parseInt(existstdReal.innerText)+1;
                    document.getElementById("barCodeInput").value='';
                    $$('.clickedTableRow').removeClass('clickedTableRow');
                    existstdReal.doSelect();
                    $$('#pageContentInventory').scrollTop(existstdReal.trHigherOffsetTop,10);
                    this.setTotalQty();
                    return;
                }
                let mainTable=document.getElementById('inventoryTable'),
                    trHigher=document.createElement('tr'),
                    tdRowNum=document.createElement('td'),tdProdName=document.createElement('td'),
                    trLower=document.createElement('tr'),
                    tdBarCode=document.createElement('td'), tdUm=document.createElement('td'),
                    tdRef=document.createElement('td'), tdReal=document.createElement('td'),
                    thisInstance=this;
                this.inventoryTableRowNum++;
                tdRowNum.style.width=(document.getElementById('num_td').offsetWidth-11) + "px";tdRowNum.className='text-centered';
                tdProdName.className="blue-text";
                trHigher.appendChild(tdRowNum); trHigher.appendChild(tdProdName);
                tdUm.style.width=(document.getElementById('um_td').offsetWidth-11) + "px";tdUm.className='text-centered';
                tdRef.style.width=(document.getElementById('doc_qty').offsetWidth-11) + "px"; tdRef.style.textAlign="center";tdRef.className='refQty';
                tdReal.style.width=(document.getElementById('real_qty').offsetWidth-11) + "px"; tdReal.style.textAlign="center";tdReal.className='realQty';
                trLower.appendChild(tdBarCode); trLower.appendChild(tdUm); trLower.appendChild(tdRef); trLower.appendChild(tdReal);
                mainTable.appendChild(trHigher); mainTable.appendChild(trLower);
                tdRowNum.rowSpan='2'; tdProdName.colSpan='4';
                tdRowNum.onclick=  function(){
                    $$('.clickedTableRow').removeClass('clickedTableRow');
                    trHigher.classList.add('clickedTableRow');trLower.classList.add('clickedTableRow');
                };
                tdProdName.onclick=tdRowNum.onclick;tdProdName.onclick=tdRowNum.onclick;
                tdBarCode.onclick=tdRowNum.onclick;tdUm.onclick=tdRowNum.onclick;
                tdRef.onclick=  function(){
                    $$('.clickedTableRow').removeClass('clickedTableRow');
                    trHigher.classList.add('clickedTableRow');trLower.classList.add('clickedTableRow');
                    thisInstance.showRealQtyFunction(tdReal, tdReal.innerText.trim(),tdProdName.innerText);
                };
                tdReal.onclick=tdRef.onclick;tdReal.doSelect=tdRowNum.onclick;
                tdRowNum.innerText=this.inventoryTableRowNum.toString();
                tdProdName.innerText=prodData["ProdName"];
                tdBarCode.innerText=prodData["Barcode"]; tdUm.innerText=prodData["UM"]; tdRef.innerText='1'; tdReal.innerText='1';
                tdReal.id=tdBarCode.innerText;tdReal.trHigherOffsetTop=trHigher.offsetTop;
                $$('.clickedTableRow').removeClass('clickedTableRow');
                trHigher.classList.add('clickedTableRow');trLower.classList.add('clickedTableRow');
                $$('#pageContentInventory').scrollTop(tdReal.trHigherOffsetTop,100);
                this.setTotalQty();
                document.getElementById("barCodeInput").value='';
            },
            setTotalQty: function(){
                var posCount=this.inventoryTableRowNum;
                document.getElementById("totalRowQty").innerHTML=posCount;
                let refQtylist = document.getElementsByClassName("refQty"), realQtylist = document.getElementsByClassName("realQty");
                let totalrefQty=0,totalrealQty=0;
                for(var tdIndex=0; tdIndex<refQtylist.length; tdIndex++){
                    totalrealQty+=parseInt(realQtylist[tdIndex].innerHTML);
                    totalrefQty+=parseInt(refQtylist[tdIndex].innerHTML);
                }
                document.getElementById("totalDocQty").innerHTML=totalrefQty;
                document.getElementById("totalRealQty").innerHTML=totalrealQty;
            },
            showRealQtyFunction: function(cell, displayedQty, prodName){
                let app7=this.$app, thisInstance=this,
                    realQtyDialog=app7.dialog.create({ title: 'Фактический остаток', destroyOnClose:true,
                        content:'<br><input id="inputRealQty" type="number" style="text-align:center;border:1px solid grey;padding:5px" value="'+displayedQty+'"></<input>',
                        text:prodName,
                        on:{
                            open:function(){
                                document.getElementById("inputRealQty").focus();
                            },
                        },
                        buttons:[{ text:"ОТМЕНА",onClick:function(){ realQtyDialog.close(); } },
                            { text:"ВВОД",keyCodes:[13],onClick:function(){
                                    cell.innerText=document.getElementById("inputRealQty").value.trim() || 0;
                                    thisInstance.setTotalQty();
                                    realQtyDialog.close();
                            } } ]
                    }).open();
            },
            barcodeInputEnter: function () {
                var self=this;
                this.getProdData($$("#barCodeInput").val(),function(prodData){
                    self.createTableRow(prodData);
                });
                $$("#barCodeInput").focus();
            },
            barcodeInputKeypress: function (e) {
                var self=this;
                if(e.keyCode==13||e.key=='Enter')
                    this.getProdData($$("#barCodeInput").val(),function(prodData){
                        self.createTableRow(prodData);
                    });
            }
        },
        on: {
            pageInit: function(e, page) {                                                                   console.log('viewInvent.html pageInit', page, this);
                let cInstance=this, app7=this.$app;
                cInstance.inventoryTableRowNum=0;
            },
            pageBeforeIn: function(e, page) {                                                                console.log('viewInvent.html pageBeforeIn', page);
                $$("#app").prop("data-workingDoc", "inventory");
                //$$("#app").addClass("inventory");
                //$$(document).workingDoc="";
                //$$('#barCodeInput').on('blur', '#barCodeInput', function(e){
                //  $$(e.target).focus();
                //});
                let maxWidth=document.getElementById("tableWithFixedHead").clientWidth+1+'px';
                document.getElementById("inventoryTable").style.marginTop=(document.getElementById("tableFixedHeader").offsetHeight)  +'px';
                document.getElementById("totalRowQty").style.width=(document.getElementById('num_td').offsetWidth-11) + "px";
                document.getElementById("totalDocQty").style.width= (document.getElementById('doc_qty').offsetWidth-11) + "px";
                document.getElementById("totalRealQty").style.width= (document.getElementById('real_qty').offsetWidth-11) + "px";
            },
            pageAfterIn: function(e, page) {                                                                console.log('viewInvent.html pageAfterIn', page);
                $$("#barCodeInput").focus();
            },
            // pageBeforeOut: function(e, page) {
            //     console.log('pageBeforeOut', page);
            // },
            // pageAfterOut: function(e, page) {
            //     console.log('pageAfterOut', page);
            // },
        }
    }
</script>
